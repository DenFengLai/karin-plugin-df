name: Release and Publish # å‘å¸ƒå’Œå‘å¸ƒçš„å·¥ä½œæµç¨‹åç§°
on:
  workflow_dispatch:
  push:
    branches:
      - main
permissions:
  contents: write # è®¾ç½®å†…å®¹çš„æƒé™ä¸ºå†™
  pull-requests: write # è®¾ç½®æ‹‰å–è¯·æ±‚çš„æƒé™ä¸ºå†™
  issues: write # è®¾ç½®é—®é¢˜çš„æƒé™ä¸ºå†™
jobs:
  release-please:
    # è®¾ç½®å·¥ä½œæµç¨‹è¿è¡Œç¯å¢ƒä¸º Ubuntu
    runs-on: ubuntu-latest
    steps:
      # ä½¿ç”¨ release-please-action@v4 åŠ¨ä½œ
      - name: ğŸ“ ä½¿ç”¨ release-please-action å‘å¸ƒæ£€æŸ¥
        uses: googleapis/release-please-action@v4
        id: release
        with:
          # è®¾ç½®å‘å¸ƒç±»å‹ä¸º Node.js
          release-type: node
          config-file: .release-please-config.json
      # æ£€å‡ºä»£ç 
      - name: ğŸ› ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        if: ${{ steps.release.outputs.release_created }}
      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: âš™ï¸ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          # è®¾ç½® Node.js ç‰ˆæœ¬
          node-version: 20
          # è®¾ç½® npm æ³¨å†Œè¡¨ URL
          registry-url: https://registry.npmjs.org
        if: ${{ steps.release.outputs.release_created }}
      # å®‰è£…ä¾èµ–
      - name: ğŸ“¦ é…ç½® PNPM ç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
        uses: pnpm/action-setup@v4
        env: 
          NPM_CONFIG_REGISTRY: https://registry.npmjs.org
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        with:
          version: 9.13.2
          run_install: true
        if: ${{ steps.release.outputs.release_created }}
      # ç¼–è¯‘
      - name: ğŸ”§ ç¼–è¯‘æºä»£ç 
        run: pnpm build
        if: ${{ steps.release.outputs.release_created }}
      # åˆ é™¤å¼€å‘ä¾èµ–
      - name: ğŸ§¹ åˆ é™¤å¼€å‘ä¾èµ–
        run: pnpm pkg delete devDependencies
        if: ${{ steps.release.outputs.release_created }}
      # å‘å¸ƒåˆ°npm
      - name: ğŸš€ å‘å¸ƒè‡³ NPM
        run: pnpm pub
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        if: ${{ steps.release.outputs.release_created }}
